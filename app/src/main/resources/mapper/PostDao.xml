<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.show_pet.post.model.dao.PostDao">

    <resultMap type="post" id="postMap">
        <id column="post_id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="hashtag" property="hashtag"/>
        <result column="category" property="category"/>
        <result column="created_at" property="createdAt"/>

        <association property="member" javaType="member">
            <id column="member_id" property="id"/>
            <result column="nickname" property="nickName"/>
        </association>

        <collection property="attachedFiles" ofType="attachedFile">
            <id column="post_file_no" property="no"/>
            <result column="filepath" property="filePath"/>
        </collection>
    </resultMap>

    <resultMap type="attachedFile" id="attachedFileMap">
        <id column="file_no" property="id"/>
        <result column="filepath" property="filePath"/>
        <result column="post_id" property="postId"/>
    </resultMap>

    <insert id="insert" parameterType="post"
            useGeneratedKeys="true" keyColumn="post_id" keyProperty="id">
        insert into post(title,content,hashtag,category,member_id)
        values(#{title},#{content},#{hashtag},#{category},#{member.id})
    </insert>

    <insert id="insertFiles" parameterType="post">
        insert into file(filepath, post_id)
        values
        <foreach collection="attachedFiles" item="file"
                 separator=",">(#{file.filePath}, #{id})
        </foreach>
    </insert>

    <select id="findBy" resultMap="postMap" parameterType="int">
        select
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        from
        post p inner join member m on p.member_id=m.member_id
        where
        p.post_id=#{id}
    </select>

    <select id="findAll" parameterType="int" resultMap="postMap">
        SELECT
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        FROM
        post p inner join member m on p.member_id=m.member_id
        ORDER BY
        p.post_id DESC
    </select>

    <select id="findEtc" parameterType="int" resultMap="postMap">
        SELECT
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        FROM
        post p inner join member m on p.member_id=m.member_id
        where
        p.category = 1
        ORDER BY
        p.post_id DESC;
    </select>

    <select id="findDog" parameterType="int" resultMap="postMap">
        SELECT
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        FROM
        post p inner join member m on p.member_id=m.member_id
        where
        p.category = 2
        ORDER BY
        p.post_id DESC;
    </select>

    <select id="findCat" parameterType="int" resultMap="postMap">
        SELECT
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        FROM
        post p inner join member m on p.member_id=m.member_id
        where
        p.category = 3
        ORDER BY
        p.post_id DESC;
    </select>

    <select id="findBird" parameterType="int" resultMap="postMap">
        SELECT
        p.post_id,
        m.nickname,
        p.title,
        p.content,
        p.hashTag,
        p.created_at
        FROM
        post p inner join member m on p.member_id=m.member_id
        where
        p.category = 4
        ORDER BY
        p.post_id DESC;
    </select>

    <select id="findFileBy" parameterType="int" resultMap="attachedFileMap">
        SELECT
        file_id,
        filepath,
        post_id
        FROM
        file
        WHERE
        file_id = #{id}
    </select>


</mapper>